# Week 8
## 内容
- デモ
    - アクションバー廃止
    - ポストの画面を色々変更 (ページ数、リブログ元の名前、notes、ローディングgif)
    - 複数画像のポストに対応
    - gifにも対応
    - 認証画面のサムネイルタップでも進める
    - メニュー画面
    - ダッシュボードのリロード
- 修正内容
    - 複数画像のポストに対応
    - avatar取得のキャッシュ化
    - Gif画像再生
    - アクションバーをなくす
    - ポストの先読みロードの数を増やす
    - メニュー画面を作る
    - 画像ロード中の表示
    - 画面上部にページ数を表示
    - オフライン状態でアプリが落ちる問題を修正
    - 認証画面のサムネイルタップでも進めるようにした
- バグ
    - オフセットがズレることがある
    - 260ページ目から同じ20件が繰り返される (未解決)
- 問題点
    - 電池消費が激しい
- 今週の Kotlin
    - なし
  

## デモ

## 修正内容の説明
### 複数画像のポストに対応
- PhotoPostには画像が複数含まれていてもすべて表示されるようにしました。
- これまでは, layoutのxmlにImageViewを一つだけ挿入していた
- PhotoPostFragment内で動的に複数のImageViewを挿入するようにした

### avatar取得のキャッシュ化
- avatarの取得にはポスト情報から、blog取得(通信発生) -> avatar url取得 (通信発生) という風に毎回2回通信が走っていたせいですごく遅かった
- さらにこの通信が頻繁に発生するせいで、ポスト取得やPhotoPostの画像取得にも影響があったような気がする (気がするだけ)
- ブログ名からavatar url取得までをキャッシュ化した
- avatar urlから画像の取得は、前回までに作成したBitmapCacheによりキャッシュ化済

### Gif画像再生
- 最初は、自分でgif再生のcustom viewを作っていましたが、途中でめんどくさくなってライブラリに頼りました(´・ω・｀)
- 使ったライブラリ https://github.com/felipecsl/GifImageView
- ポスト画像のURLが".gif"で終わっていたら、GifImageViewで表示しています

### アクションバーをなくす
- アクションバーは高さを取る割りに情報量がほとんどないのでなくした
- AndroidManifestでスタイルをNoActionBarにするだけ

### ポストの先読みロードの数を増やす
- 20件ずつは少ない気がするので増やした
    - たくさんロードしておけば、オフラインになってもテキストは読める (画像は表示時にロードしてるので無理)
- 初回300件、次回以降20ページを切ったら100件ずつダウンロード 
 
### メニュー画面を作る
- アクションバーにあったメニューをメニュー画面として、フローティングボタンから呼び出せるようにした
- フラグメントの遷移の実装はなんとなくで作ったので、これでいいのかかなり不安
- 個人的にはダッシュボードの上にフローティングUIとして見せたい。。。
- フローティングボタンがコンテンツを隠してしまっているのでなんとかしたい

### 画像ロード中の表示
- PhotoPostの画像ロード中はtumpacaが走っているアニメーションgifを表示
- viewを正方形にして表示するために、GifImageViewを継承したGifSquareImageViewを作成
- onMeasure()のなかで横幅を縦幅にセットすることで正方形にできる

### 画面上部にページ数を表示
- 前々回の僕の回でアクションバーに表示していたページ数を画面上部に小さくひっそりと表示するようにしました

### オフライン状態でアプリが落ちる問題を修正
- AsyncTaskHelperのdoInBackgroundの中で、first()の結果が例外を投げるとそれが上まで突き抜けて落ちる
- AsyncTaskResult classを作ってエラーをそこに閉じ込め、onPostExecute内で適切に処理するようにした
- AsyncTaskHelperをabstract classにし、利用する側でバックグラウンド処理, エラー処理, 成功時処理を実装するようにした
 
### 認証画面のサムネイルタップでも進めるようにした
- なんとなくサムネイルをタップしてしまうので

### ダッシュボードのリロード
- ダッシュボードをリロード出来るようにした
- リロード自体はMainActivity内で自分自身をIntent起動
- DashboardFragmentのonCreateView内で、一旦TumblrServicesのpostsをnullセットするようにした。
    - リロード時はここを通るのでpostsがnullにセットされ最初からダウンロードされる

## バグ
### オフセットがズレることがある
- ダッシュボード取得のオフセットにposts.sizeを使っていましたが、postsはポストの種類によってフィルターしているので、オフセット位置としては正しくない
- tumblr apiのダッシュボード取得にはsince_idというパラメータがあり、それが使えるかと思ったが、実際使ってみると指定したIDより新しいポストをとってくるという仕様だったので、だめだった・・・
- 結局、フィルター前の取得ポストの数を使ってオフセット用のプロパティをPostListにもたせるようにした

### 260ページ目から同じ20件が繰り返される (未解決)
- なぜか261ページ目が1ページ目と同じ内容
- これ以降20ページごとに1ページ目から20ページ目の内容が繰り返される
- offsetは正しい

- 調べてみると公式ドキュメントには書いていないですが、offsetは250までしか効かないらしい。
    - [Tumblr APIでダッシュボードを270件以上深く潜る方法 (Qiita)](http://qiita.com/newton/items/57ed217a7b486c2a52ba)
- 250より大きい値が指定すると、エラーになるわけでもなく、offset = 0として扱われる困った仕様
- この問題を解決するにはsince_idの推測によるダッシュボード取得アルゴリズムを考える必要がありそう
- since_idは全ユーザでユニークな連番
- 取得した最後のポストのIDに適切な値を引いたIDでダッシュボードを取得すれば、offset = 250を超えて、ポストを取得できる

## 問題点
### 電池消費が激しい
- 最大の原因はgifアニメーション
- 複数画像ポストで全部gifだった場合は、画面に表示している限り、CPU使用率90%前後をうろうろ
- gifポストを表示した状態でタスク切り替えしてもバックグラウンドでCPUぶん回してる
- 対策
    - 簡単にできる対策としては、取得する画像のサイズ指定を小さいものにする
    - Tumblrでは画像リソースに複数サイズが用意されていて、PhotoPostからサイズごとのURLを取得できる
    - 今は大きめの画像をとっている (PhotoPostFragmentの38行目) で、そこを調整すれば大丈夫かも。
    - 例えば、lteまたは3gなら小さい画像, wifiなら大きい画像、gifは常に小さい画像みたいなチューニングはありかも
    - また高解像度画像を取得するスイッチを設定画面に用意するのもよさそう

## 今週の Kotlin
### なし
